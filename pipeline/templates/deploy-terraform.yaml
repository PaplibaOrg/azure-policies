parameters:
  - name: serviceConnection
    type: string
  - name: environment
    type: string
    # Note: Approvals should be configured on the environment in Azure DevOps
    # Go to Pipelines > Environments > [environment name] > Approvals and checks
  - name: workingDirectory
    type: string
  - name: resourceType
    type: string
    # Short name for stage identifiers (e.g., "PolicyDef", "PolicyInit", "PolicyAssign")
  - name: resourceDisplayName
    type: string
    # Full display name (e.g., "Policy Definitions", "Policy Initiatives", "Policy Assignments")
  - name: runPlanInApply
    type: boolean
    default: false
    # Whether to run terraform plan before apply in the Apply stage
  - name: subscriptionId
    type: string
    # Explicit subscription ID to set context before Terraform operations
  - name: backendResourceGroupName
    type: string
  - name: backendStorageAccountName
    type: string
  - name: backendContainerName
    type: string
  - name: backendKey
    type: string
  - name: managementGroupId
    type: string
    # Management group ID for the deployment (e.g., dev-plb-root, test-plb-root, plb-root)

stages:
  # Plan Stage
  - stage: Plan_${{ parameters.resourceType }}_${{ parameters.environment }}
    displayName: 'Plan: ${{ parameters.resourceDisplayName }} (${{ parameters.environment }})'
    jobs:
      - job: TfPlan
        displayName: 'Plan: ${{ parameters.resourceDisplayName }} ${{ parameters.environment }}'
        steps:
          - task: AzureCLI@2
            displayName: "Plan: Terraform ${{ parameters.resourceDisplayName }}"
            inputs:
              azureSubscription: ${{ parameters.serviceConnection }}
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Set Azure subscription context
                az account set --subscription "${{ parameters.subscriptionId }}"
                
                cd ${{ parameters.workingDirectory }}
                
                # Get Azure context and set ARM variables for Azure provider authentication
                SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                TENANT_ID=$(az account show --query tenantId -o tsv)
                CLIENT_ID=$(az account show --query user.name -o tsv)
                
                # Set ARM environment variables for Terraform Azure provider
                export ARM_SUBSCRIPTION_ID=$SUBSCRIPTION_ID
                export ARM_TENANT_ID=$TENANT_ID
                export ARM_CLIENT_ID=$CLIENT_ID
                export ARM_USE_OIDC=true
                
                # Unset Azure CLI config to force Terraform to use ARM variables instead of Azure CLI
                unset AZURE_CONFIG_DIR
                
                echo "ARM_SUBSCRIPTION_ID: $ARM_SUBSCRIPTION_ID"
                echo "ARM_TENANT_ID: $ARM_TENANT_ID"
                echo "ARM_CLIENT_ID: $CLIENT_ID"
                echo "ARM_USE_OIDC: $ARM_USE_OIDC"
                
                terraform init -upgrade \
                  -backend-config="resource_group_name=${{ parameters.backendResourceGroupName }}" \
                  -backend-config="storage_account_name=${{ parameters.backendStorageAccountName }}" \
                  -backend-config="container_name=${{ parameters.backendContainerName }}" \
                  -backend-config="key=${{ parameters.backendKey }}"
                
                # Unlock state if locked (replace with actual lock ID from error if different)
                # terraform force-unlock -force <LOCK_ID> || echo "Lock already released or unlock failed, continuing..."
                
                terraform plan -var="management_group_id=${{ parameters.managementGroupId }}"

  # Apply Stage
  - stage: Apply_${{ parameters.resourceType }}_${{ parameters.environment }}
    displayName: 'Apply: ${{ parameters.resourceDisplayName }} (${{ parameters.environment }})'
    dependsOn: Plan_${{ parameters.resourceType }}_${{ parameters.environment }}
    jobs:
      - deployment: TfApply
        displayName: 'Apply: ${{ parameters.resourceDisplayName }} ${{ parameters.environment }}'
        environment: ${{ parameters.environment }}
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: "Apply: Terraform ${{ parameters.resourceDisplayName }}"
                  inputs:
                    azureSubscription: ${{ parameters.serviceConnection }}
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Set Azure subscription context
                      az account set --subscription "${{ parameters.subscriptionId }}"
                      
                      cd ${{ parameters.workingDirectory }}
                       
                      # Get Azure context and set ARM variables for Azure provider authentication
                      SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                      TENANT_ID=$(az account show --query tenantId -o tsv)
                      CLIENT_ID=$(az account show --query user.name -o tsv)
                      
                      # Set ARM environment variables for Terraform Azure provider
                      export ARM_SUBSCRIPTION_ID=$SUBSCRIPTION_ID
                      export ARM_TENANT_ID=$TENANT_ID
                      export ARM_CLIENT_ID=$CLIENT_ID
                      export ARM_USE_OIDC=true
                      
                      # Unset Azure CLI config to force Terraform to use ARM variables instead of Azure CLI
                      unset AZURE_CONFIG_DIR
                      
                      echo "ARM_SUBSCRIPTION_ID: $ARM_SUBSCRIPTION_ID"
                      echo "ARM_TENANT_ID: $ARM_TENANT_ID"
                      echo "ARM_CLIENT_ID: $CLIENT_ID"
                      echo "ARM_USE_OIDC: $ARM_USE_OIDC"
                      
                      terraform init -upgrade \
                        -backend-config="resource_group_name=${{ parameters.backendResourceGroupName }}" \
                        -backend-config="storage_account_name=${{ parameters.backendStorageAccountName }}" \
                        -backend-config="container_name=${{ parameters.backendContainerName }}" \
                        -backend-config="key=${{ parameters.backendKey }}"
                      
                      if [ "${{ parameters.runPlanInApply }}" = "true" ]; then
                        terraform plan -var="management_group_id=${{ parameters.managementGroupId }}"
                      fi
                      
                      terraform apply -auto-approve -var="management_group_id=${{ parameters.managementGroupId }}"
